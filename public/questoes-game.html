<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuestÃµes Game 3D - Quiron Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1d2e;
            color: white;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid white;
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 30px;
        }

        .toolbar {
            background: #252837;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .search-box input {
            padding: 12px 20px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            font-size: 14px;
            background: rgba(255,255,255,0.05);
            color: white;
            min-width: 300px;
        }

        .search-box input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 10px 15px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            font-size: 14px;
            background: rgba(255,255,255,0.05);
            color: white;
            cursor: pointer;
        }

        .layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 30px;
        }

        .sidebar {
            background: #252837;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            padding: 25px;
            height: fit-content;
            position: sticky;
            top: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar h3 {
            font-size: 16px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }

        .area-cards {
            display: grid;
            gap: 15px;
        }

        .area-card {
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid;
            position: relative;
            overflow: hidden;
        }

        .area-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 12px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: -1;
        }

        .area-card:hover::before {
            opacity: 0.5;
        }

        .area-card.juridica {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .area-card.juridica.active {
            background: rgba(59, 130, 246, 0.2);
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.3);
        }

        .area-card.policial {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .area-card.policial.active {
            background: rgba(239, 68, 68, 0.2);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.3);
        }

        .area-card.fiscal-bancaria {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .area-card.fiscal-bancaria.active {
            background: rgba(245, 158, 11, 0.2);
            box-shadow: 0 0 30px rgba(245, 158, 11, 0.3);
        }

        .area-card.conhecimentos-gerais {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }

        .area-card.conhecimentos-gerais.active {
            background: rgba(139, 92, 246, 0.2);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
        }

        .area-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .area-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .area-count {
            font-size: 13px;
            opacity: 0.7;
        }

        .materias-list {
            margin-top: 15px;
            display: none;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .materias-list.show {
            display: block;
        }

        .materia-item {
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            background: rgba(255,255,255,0.05);
            border-left: 3px solid transparent;
        }

        .materia-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .materia-item.active {
            background: rgba(255,255,255,0.15);
            border-left-color: currentColor;
            font-weight: 600;
        }

        .main-content {
            background: #252837;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }

        .content-header h2 {
            font-size: 22px;
        }

        .stats-bar {
            display: flex;
            gap: 30px;
            font-size: 13px;
            color: rgba(255,255,255,0.7);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-number {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }

        .questions-grid {
            display: grid;
            gap: 20px;
        }

        .question-card {
            background: rgba(255,255,255,0.03);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s;
        }

        .question-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .question-id {
            font-size: 12px;
            font-weight: 600;
            color: #667eea;
            background: rgba(102, 126, 234, 0.2);
            padding: 5px 12px;
            border-radius: 6px;
        }

        .question-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tag {
            font-size: 11px;
            padding: 5px 12px;
            border-radius: 6px;
            font-weight: 600;
        }

        .tag-area {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .tag-subject {
            background: rgba(139, 92, 246, 0.2);
            color: #c4b5fd;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .tag-difficulty {
            padding: 5px 12px;
            border-radius: 6px;
            font-weight: 600;
        }

        .tag-difficulty.facil {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .tag-difficulty.medio {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .tag-difficulty.dificil {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .question-text {
            font-size: 16px;
            line-height: 1.6;
            margin: 20px 0;
            color: rgba(255,255,255,0.9);
        }

        .answer-box {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .answer-box.correct {
            background: rgba(16, 185, 129, 0.15);
            border: 2px solid rgba(16, 185, 129, 0.3);
        }

        .answer-box.incorrect {
            background: rgba(239, 68, 68, 0.15);
            border: 2px solid rgba(239, 68, 68, 0.3);
        }

        .answer-icon {
            font-size: 28px;
        }

        .answer-label {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .explanation {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
        }

        .explanation-title {
            font-size: 13px;
            font-weight: 700;
            color: #93c5fd;
            margin-bottom: 8px;
        }

        .explanation-text {
            font-size: 14px;
            color: rgba(255,255,255,0.8);
            line-height: 1.6;
        }

        .question-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #252837;
            border-radius: 20px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 40px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .modal-header h2 {
            font-size: 24px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            font-size: 14px;
            background: rgba(255,255,255,0.05);
            color: white;
            font-family: inherit;
        }

        /* CorreÃ§Ã£o para opÃ§Ãµes do select ficarem visÃ­veis */
        .form-group select option {
            background-color: #1a1d2e;
            color: white;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            pointer-events: auto !important;
            position: relative;
            z-index: 10;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid rgba(255,255,255,0.1);
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: rgba(255,255,255,0.5);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .loading-spinner {
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <span>ðŸŽ®</span>
            QuestÃµes Game 3D (Certo/Errado)
        </h1>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-success" onclick="abrirNoJogo()">
                ðŸŽ® Abrir no Jogo
            </button>
            <button class="btn btn-secondary" onclick="window.location.href='dashboard.html'">
                â† Voltar
            </button>
        </div>
    </div>

    <script>
        function abrirNoJogo() {
            if (!currentArea) {
                alert('Selecione uma Ã¡rea no menu lateral primeiro!');
                return;
            }
            
            // Caminho para o jogo (ajuste se necessÃ¡rio)
            const gamePath = '/godot-game/index.html';
            
            // Construir URL com parÃ¢metros
            let url = `${gamePath}?area=${currentArea}`;
            if (currentSubject) {
                url += `&subjects=${encodeURIComponent(currentSubject)}`;
            }
            
            console.log('ðŸŽ® Abrindo jogo com URL:', url);
            window.open(url, '_blank');
        }
    </script>

    <div class="container">
        <!-- Toolbar -->
        <div class="toolbar">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ðŸ” Buscar questÃµes..." onkeyup="filterQuestions()">
            </div>
            <div class="filters">
                <select class="filter-select" id="filterDifficulty" onchange="filterQuestions()">
                    <option value="">âš¡ Todas Dificuldades</option>
                    <option value="facil">FÃ¡cil</option>
                    <option value="medio">MÃ©dio</option>
                    <option value="dificil">DifÃ­cil</option>
                </select>
                <select class="filter-select" id="filterAnswer" onchange="filterQuestions()">
                    <option value="">âœ… Todas Respostas</option>
                    <option value="true">Certo</option>
                    <option value="false">Errado</option>
                </select>
                <button class="btn btn-success" onclick="openAddModal()">
                    âž• Nova QuestÃ£o
                </button>
            </div>
        </div>

        <!-- Layout -->
        <div class="layout">
            <!-- Sidebar -->
            <div class="sidebar">
                <h3>ðŸŽ¯ Ãreas TemÃ¡ticas</h3>
                <div class="area-cards" id="areaCards">
                    <!-- Carregado dinamicamente -->
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <div class="content-header">
                    <div>
                        <h2 id="contentTitle">Todas as QuestÃµes</h2>
                    </div>
                    <div class="stats-bar">
                        <div class="stat-item">
                            <span class="stat-number" id="statTotal">0</span>
                            <span>questÃµes</span>
                        </div>
                    </div>
                </div>

                <div id="questionsContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Carregando questÃµes...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="questionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">âž• Nova QuestÃ£o</h2>
            </div>

            <form id="questionForm">
                <div class="form-group">
                    <label>ID da QuestÃ£o *</label>
                    <input type="text" id="inputId" required placeholder="Ex: const-01">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Ãrea *</label>
                        <select id="inputArea" required onchange="updateSubjectsList()">
                            <option value="">Selecione...</option>
                            <option value="juridica">ðŸ“˜ JurÃ­dica</option>
                            <option value="policial">ðŸš” Policial</option>
                            <option value="fiscal-bancaria">ðŸ’° Fiscal-BancÃ¡ria</option>
                            <option value="conhecimentos-gerais">ðŸ§  Conhecimentos Gerais</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>MatÃ©ria *</label>
                        <select id="inputSubject" required>
                            <option value="">Selecione Ã¡rea primeiro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Dificuldade *</label>
                        <select id="inputDifficulty" required>
                            <option value="">Selecione...</option>
                            <option value="facil">FÃ¡cil</option>
                            <option value="medio">MÃ©dio</option>
                            <option value="dificil">DifÃ­cil</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Enunciado *</label>
                    <textarea id="inputEnunciado" required placeholder="Digite o enunciado da questÃ£o..."></textarea>
                </div>

                <div class="form-group">
                    <label>Resposta Correta *</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="answer" value="true" id="answerTrue">
                            âœ… Certo
                        </label>
                        <label>
                            <input type="radio" name="answer" value="false" id="answerFalse">
                            âŒ Errado
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>ExplicaÃ§Ã£o *</label>
                    <textarea id="inputExplicacao" required placeholder="Digite a explicaÃ§Ã£o detalhada..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-success" style="flex: 1;">
                        ðŸ’¾ Salvar QuestÃ£o
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script>
        const SUPABASE_URL = 'https://lrmabyfaunhrdvdzocrz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxybWFieWZhdW5ocmR2ZHpvY3J6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNDQ4NDUsImV4cCI6MjA3ODkyMDg0NX0.XALJ51MUjxw93j4NkJu3cFusKOAIY1LlClg_tbIy_r0';
        
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let supabaseAdmin = null;

        // Verificar autenticaÃ§Ã£o
        if (localStorage.getItem('quiron_admin_logged') !== 'true') {
            window.location.href = 'index.html';
        }

        // Tentar carregar chave de admin salva
        const savedKey = localStorage.getItem('quiron_service_key');
        if (savedKey) {
            supabaseAdmin = window.supabase.createClient(SUPABASE_URL, savedKey);
        }

        /**
         * Detecta a Ã¡rea de uma questÃ£o analisando tags, area e subject
         * Retorna: 'juridica', 'policial', 'fiscal_bancaria' ou 'conhecimentos_gerais'
         */
        function getQuestionArea(question) {
            const tags = Array.isArray(question.tags) ? question.tags.map(t => String(t).toLowerCase()) : [];
            const subject = (question.subject || '').toLowerCase();
            const text = (question.question_text || question.enunciado || '').toLowerCase();

            // 1. Tags (check all tags)
            if (tags.some(t => t.includes('juridica') || t.includes('direito'))) return 'juridica';
            if (tags.some(t => t.includes('policial') || t.includes('seguranca') || t.includes('procedimentos'))) return 'policial';
            if (tags.some(t => t.includes('fiscal') || t.includes('bancaria') || t.includes('economia'))) return 'fiscal_bancaria';
            if (tags.some(t => t.includes('conhecimentos') || t.includes('geral') || t.includes('portugues'))) return 'conhecimentos_gerais';
            
            // 2. Subject
            if (subject.includes('direito') || subject.includes('constitucional') || subject.includes('penal') || subject.includes('civil') || subject.includes('administrativo')) return 'juridica';
            if (subject.includes('policial') || subject.includes('criminologia')) return 'policial';
            if (subject.includes('economia') || subject.includes('afo') || subject.includes('contab')) return 'fiscal_bancaria';
            
            // 3. Text content fallback
            if (text.includes('direito') || text.includes('penal') || text.includes('constitucional')) return 'juridica';

            return 'conhecimentos_gerais';
        }

        const ESTRUTURA_GAME = {
            juridica: {
                nome: 'Ãrea JurÃ­dica',
                icon: 'ðŸŽ¯',
                subjects: ['Direito Constitucional', 'Direito Administrativo', 'Direito Penal', 'Direito Civil', 'Direito do Trabalho']
            },
            policial: {
                nome: 'Ãrea Policial',
                icon: 'ðŸ”¥',
                subjects: ['LegislaÃ§Ã£o Penal Especial', 'Criminologia', 'Direitos Humanos', 'Procedimentos Policiais']
            },
            'fiscal_bancaria': {
                nome: 'Ãrea Fiscal-BancÃ¡ria',
                icon: 'ðŸ‘‘',
                subjects: ['AFO', 'Contabilidade', 'Economia', 'Conhecimentos BancÃ¡rios', 'MatemÃ¡tica Financeira']
            },
            'conhecimentos_gerais': {
                nome: 'Conhecimentos Gerais',
                icon: 'âš¡',
                subjects: ['PortuguÃªs', 'RaciocÃ­nio LÃ³gico', 'InformÃ¡tica', 'Atualidades', 'HistÃ³ria']
            }
        };

        let allQuestions = [];
        let filteredQuestions = [];
        let currentArea = null;
        let currentSubject = null;
        let editingQuestion = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadAreasSidebar();
            loadQuestions();
        });

        function loadAreasSidebar() {
            const container = document.getElementById('areaCards');
            let html = '';

            for (const [key, data] of Object.entries(ESTRUTURA_GAME)) {
                // key pode ser 'fiscal_bancaria', mas classe CSS usa 'fiscal-bancaria'
                const cssClass = key.replace('_', '-');
                
                html += `
                    <div class="area-card ${cssClass}" onclick="toggleArea('${key}')">
                        <div class="area-icon">${data.icon}</div>
                        <div class="area-name">${data.nome}</div>
                        <div class="area-count" id="count-${key}">0 questÃµes</div>
                        
                        <div class="materias-list" id="materias-${key}">
                `;

                data.subjects.forEach(subject => {
                    html += `
                        <div class="materia-item" onclick="selectSubject('${key}', '${subject}', event)">
                            ${subject}
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function toggleArea(area) {
            const materiasList = document.getElementById(`materias-${area}`);
            const card = event.currentTarget;
            
            document.querySelectorAll('.area-card').forEach(c => {
                if (c !== card) {
                    c.classList.remove('active');
                    const list = c.querySelector('.materias-list');
                    if (list) list.classList.remove('show');
                }
            });

            card.classList.toggle('active');
            materiasList.classList.toggle('show');

            currentArea = card.classList.contains('active') ? area : null;
            currentSubject = null;
            
            document.querySelectorAll('.materia-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById('contentTitle').textContent = 
                currentArea ? ESTRUTURA_GAME[currentArea].nome : 'Todas as QuestÃµes';
            
            filterQuestions();
        }

        function selectSubject(area, subject, event) {
            event.stopPropagation();
            
            currentArea = area;
            currentSubject = subject;

            document.querySelectorAll('.materia-item').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('contentTitle').textContent = subject;
            filterQuestions();
        }

        function updateSubjectsList() {
            const area = document.getElementById('inputArea').value;
            const subjectSelect = document.getElementById('inputSubject');

            if (!area) {
                subjectSelect.innerHTML = '<option value="">Selecione Ã¡rea primeiro</option>';
                return;
            }

            // Normalizar Ã¡rea do input para a chave da ESTRUTURA_GAME
            let structureKey = area;
            if (area === 'fiscal-bancaria') structureKey = 'fiscal_bancaria';
            if (area === 'conhecimentos-gerais') structureKey = 'conhecimentos_gerais';

            let html = '<option value="">Selecione...</option>';
            if (ESTRUTURA_GAME[structureKey]) {
                ESTRUTURA_GAME[structureKey].subjects.forEach(subject => {
                    html += `<option value="${subject}">${subject}</option>`;
                });
            }

            subjectSelect.innerHTML = html;
        }

        // Helper para normalizar strings (remover acentos, lowercase, hÃ­fens)
        function normalizeString(str) {
            if (!str) return '';
            // Remove acentos, converte para minÃºsculo, substitui hÃ­fens por espaÃ§os
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/-/g, ' ');
        }

        async function loadQuestions() {
            try {
                console.log('ðŸ“‹ Carregando questÃµes via Supabase...');
                
                // Usar cliente admin se disponÃ­vel
                const client = supabaseAdmin || supabaseClient;
                
                const { data, error } = await client
                    .from('questions')
                    .select('id, question_text, options, correct_answer, explanation, subject, difficulty, tags')
                    .limit(10000);

                if (error) throw error;

                // Filtrar apenas questÃµes Certo/Errado para o Game (compatibilidade)
                const validQuestions = data.filter(q => {
                    const isCE = q.correct_answer === 'C' || q.correct_answer === 'E';
                    const opts = q.options || {};
                    const isBool = opts.correctAnswer === true || opts.correctAnswer === false;
                    return isCE || isBool;
                });

                // Mapear para o formato do Game
                allQuestions = validQuestions.map(q => {
                    // Usar a nova funÃ§Ã£o de detecÃ§Ã£o de Ã¡rea
                    const detectedArea = getQuestionArea(q);
                    
                    let subject = q.subject || 'Geral';
                    
                    // Tratamento de dificuldade (banco Ã© UPPERCASE, UI espera lowercase)
                    let diff = 'medio';
                    if (q.difficulty === 'FÃCIL') diff = 'facil';
                    if (q.difficulty === 'DIFÃCIL') diff = 'dificil';

                    // Tratamento de resposta
                    let isCorrect = false;
                    // Se for C/E
                    if (q.correct_answer === 'C') isCorrect = true;
                    // Se for mÃºltipla escolha, tentar inferir (difÃ­cil sem saber a opÃ§Ã£o certa vs texto)
                    // Por enquanto, consideramos apenas o formato C/E como nativo do game
                    // Mas vamos deixar flexÃ­vel
                    
                    return {
                        id: q.id,
                        area: detectedArea,
                        subject: subject,
                        difficulty: diff,
                        enunciado: q.question_text || q.question || 'Sem enunciado',
                        answer: isCorrect,
                        explicacao: q.explanation || '',
                        raw_correct_answer: q.correct_answer, // Guardar valor original
                        tags: q.tags || [] // IMPORTANTE: Guardar tags para filtro
                    };
                });

                console.log(`âœ… ${allQuestions.length} questÃµes carregadas do Banco`);
                
                filterQuestions();
                updateCounters();

            } catch (error) {
                console.error('âŒ Erro ao carregar questÃµes:', error);
                allQuestions = [];
                filterQuestions();
                updateCounters();
            }
        }

        function filterQuestions() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const difficulty = document.getElementById('filterDifficulty').value;
            const answer = document.getElementById('filterAnswer').value;

            console.log('ðŸ” Filtrando questÃµes - Ãrea:', currentArea, '| MatÃ©ria:', currentSubject);

            filteredQuestions = allQuestions.filter(q => {
                // 1. Filtro de ÃREA RIGOROSO
                if (currentArea && q.area !== currentArea) {
                    return false;
                }
                
                // 2. Filtro de MATÃ‰RIA RIGOROSO (com normalizaÃ§Ã£o)
                if (currentSubject) {
                    const qSubject = normalizeString(q.subject);
                    const targetSubject = normalizeString(currentSubject);
                    
                    // Verifica correspondÃªncia (includes bidirecional para ser mais resiliente)
                    const subjectMatches = qSubject.includes(targetSubject) || targetSubject.includes(qSubject);
                    
                    // Verifica tags especÃ­ficas
                    const tagMatches = q.tags && Array.isArray(q.tags) && q.tags.some(t => {
                        const normTag = normalizeString(t);
                        return normTag === targetSubject || normTag.includes(targetSubject) || targetSubject.includes(normTag);
                    });
                    
                    if (!subjectMatches && !tagMatches) {
                        return false;
                    }
                }

                // 3. Filtro de BUSCA
                if (search && !q.enunciado.toLowerCase().includes(search)) {
                    return false;
                }

                // 4. Filtro de DIFICULDADE
                if (difficulty && q.difficulty !== difficulty) {
                    return false;
                }
                
                // 5. Filtro de RESPOSTA
                if (answer) {
                    const boolAnswer = answer === 'true';
                    if (q.answer !== boolAnswer) return false;
                }

                return true;
            });

            console.log(`âœ… ${filteredQuestions.length} questÃµes filtradas de ${allQuestions.length} total`);
            renderQuestions();
        }

        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            document.getElementById('statTotal').textContent = filteredQuestions.length;

            if (filteredQuestions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ”</div>
                        <div>Nenhuma questÃ£o encontrada</div>
                    </div>
                `;
                return;
            }

            let html = '<div class="questions-grid">';

            filteredQuestions.forEach(q => {
                const difficultyText = {facil: 'FÃ¡cil', medio: 'MÃ©dio', dificil: 'DifÃ­cil'};
                
                const areaInfo = ESTRUTURA_GAME[q.area] || { nome: q.area || 'Geral', icon: 'â“' };
                
                // Badge de Ã¡rea style
                let areaStyle = '';
                if (q.area === 'conhecimentos_gerais') {
                    areaStyle = 'background: rgba(139, 92, 246, 0.2); color: #c4b5fd; border-color: rgba(139, 92, 246, 0.3);';
                } else if (q.area === 'fiscal_bancaria') {
                    areaStyle = 'background: rgba(245, 158, 11, 0.2); color: #fcd34d; border-color: rgba(245, 158, 11, 0.3);';
                }
                
                // Exibir resposta (adaptado para MÃºltipla Escolha se necessÃ¡rio)
                let answerHtml = '';
                if (['A','B','C','D','E'].includes(q.raw_correct_answer)) {
                    answerHtml = `
                        <div class="answer-box" style="background: rgba(59, 130, 246, 0.15); border: 2px solid rgba(59, 130, 246, 0.3);">
                            <div class="answer-icon">ðŸ“</div>
                            <div class="answer-label">Gabarito: ${q.raw_correct_answer}</div>
                        </div>
                    `;
                } else {
                    answerHtml = `
                        <div class="answer-box ${q.answer ? 'correct' : 'incorrect'}">
                            <div class="answer-icon">${q.answer ? 'âœ…' : 'âŒ'}</div>
                            <div class="answer-label">${q.answer ? 'Certo' : 'Errado'}</div>
                        </div>
                    `;
                }

                html += `
                    <div class="question-card">
                        <div class="question-header">
                            <div class="question-id">${q.id.substring(0, 8)}...</div>
                            <div class="question-tags">
                                <span class="tag tag-area" style="${areaStyle}">${areaInfo.nome}</span>
                                <span class="tag tag-subject">${q.subject}</span>
                                <span class="tag-difficulty ${q.difficulty}">${difficultyText[q.difficulty] || q.difficulty}</span>
                            </div>
                        </div>

                        <div class="question-text">${q.enunciado}</div>

                        ${answerHtml}

                        <div class="explanation">
                            <div class="explanation-title">ðŸ’¡ ExplicaÃ§Ã£o:</div>
                            <div class="explanation-text">${q.explicacao}</div>
                        </div>

                        <div class="question-actions">
                            <button class="btn btn-primary btn-sm" onclick="editQuestion('${q.id}')">
                                âœï¸ Editar
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteQuestion('${q.id}')">
                                ðŸ—‘ï¸ Deletar
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function updateCounters() {
            const counts = {
                'juridica': 0,
                'policial': 0,
                'fiscal_bancaria': 0,
                'conhecimentos_gerais': 0
            };

            allQuestions.forEach(q => {
                if (counts[q.area] !== undefined) {
                    counts[q.area]++;
                } else {
                    counts['conhecimentos_gerais']++;
                }
            });

            for (const area of Object.keys(ESTRUTURA_GAME)) {
                // ESTRUTURA_GAME usa keys como 'fiscal_bancaria'
                // O HTML dos contadores usa id="count-fiscal_bancaria"
                const el = document.getElementById(`count-${area}`);
                if (el) {
                    el.textContent = `${counts[area]} questÃµes`;
                }
            }
        }

        function openAddModal() {
            editingQuestion = null;
            document.getElementById('modalTitle').textContent = 'âž• Nova QuestÃ£o';
            document.getElementById('questionForm').reset();
            document.getElementById('questionModal').classList.add('show');
            setTimeout(() => document.getElementById('inputId').focus(), 100);
        }

        function editQuestion(id) {
            const question = allQuestions.find(q => q.id === id);
            if (!question) {
                alert('Erro: QuestÃ£o nÃ£o encontrada na memÃ³ria.');
                return;
            }

            editingQuestion = question;
            document.getElementById('modalTitle').textContent = 'âœï¸ Editar QuestÃ£o';

            document.getElementById('inputId').value = question.id;
            document.getElementById('inputArea').value = question.area;
            updateSubjectsList();
            document.getElementById('inputSubject').value = question.subject;
            document.getElementById('inputDifficulty').value = question.difficulty;
            document.getElementById('inputEnunciado').value = question.enunciado;
            
            // Selecionar resposta (Certo/Errado)
            const val = question.answer ? 'true' : 'false';
            const radio = document.querySelector(`input[name="answer"][value="${val}"]`);
            if (radio) radio.checked = true;
            
            document.getElementById('inputExplicacao').value = question.explicacao;

            document.getElementById('questionModal').classList.add('show');
            setTimeout(() => document.getElementById('inputId').focus(), 100);
        }

        function closeModal() {
            document.getElementById('questionModal').classList.remove('show');
        }

        // Configurar Chave de ServiÃ§o
        async function configServiceKey() {
            const key = prompt('Cole a Service Role Key do Supabase:\n\n(Encontre em: Settings â†’ API â†’ service_role)\n\nATENÃ‡ÃƒO: Esta chave dÃ¡ acesso total ao banco!', localStorage.getItem('quiron_service_key') || '');
            
            if (!key || key.trim() === '') {
                alert('âŒ Chave nÃ£o fornecida. OperaÃ§Ãµes de ediÃ§Ã£o nÃ£o estarÃ£o disponÃ­veis.');
                return;
            }
            
            try {
                // Criar cliente com permissÃµes de admin
                supabaseAdmin = window.supabase.createClient(SUPABASE_URL, key.trim());
                
                // Testar se a chave funciona
                const { data, error } = await supabaseAdmin
                    .from('kv_store_50734795')
                    .select('key')
                    .limit(1);
                
                if (error) {
                    throw new Error('Chave invÃ¡lida ou sem permissÃµes');
                }
                
                // Salvar chave
                localStorage.setItem('quiron_service_key', key.trim());

                alert('âœ… Chave configurada com sucesso!\n\nAgora vocÃª pode editar, criar e deletar questÃµes.');
                location.reload();
                
            } catch (error) {
                alert('âŒ Erro ao configurar chave:\n\n' + error.message + '\n\nVerifique se a chave estÃ¡ correta.');
                supabaseAdmin = null;
            }
        }

        document.getElementById('questionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!supabaseAdmin) {
                alert('âŒ Erro: Para salvar, vocÃª precisa configurar a Service Role Key no botÃ£o superior.');
                return;
            }

            const answer = document.querySelector('input[name="answer"]:checked');
            if (!answer) {
                alert('Selecione a resposta correta!');
                return;
            }

            const question = {
                id: document.getElementById('inputId').value,
                area: document.getElementById('inputArea').value,
                subject: document.getElementById('inputSubject').value,
                difficulty: document.getElementById('inputDifficulty').value,
                enunciado: document.getElementById('inputEnunciado').value,
                answer: answer.value === 'true',
                explicacao: document.getElementById('inputExplicacao').value
            };

            try {
                console.log('ðŸ’¾ Salvando questÃ£o na tabela questions...', question.id);
                
                const { error } = await supabaseAdmin
                    .from('questions')
                    .upsert({
                        id: question.id,
                        question_text: question.enunciado,
                        correct_answer: question.answer ? 'C' : 'E',
                        explanation: question.explicacao || 'Sem explicaÃ§Ã£o.',
                        subject: question.subject || 'Geral', // Campo obrigatÃ³rio
                        options: {
                            area: `${question.area}:${question.subject}`,
                            difficulty: question.difficulty,
                            correctAnswer: question.answer, // true/false
                            explanation: question.explicacao
                        }
                    });

                if (error) throw error;
                
                alert('âœ… QuestÃ£o salva com sucesso no Supabase!');
                closeModal();
                loadQuestions();

            } catch (error) {
                console.error('âŒ Erro:', error);
                alert(`âŒ Erro: ${error.message}`);
            }
        });

        async function deleteQuestion(id) {
            if (!confirm('Deletar esta questÃ£o permanentemente do Supabase?')) return;
            
            if (!supabaseAdmin) {
                alert('âŒ Erro: Para deletar, vocÃª precisa configurar a Service Role Key.');
                return;
            }

            try {
                console.log(`ðŸ—‘ï¸ Deletando questÃ£o: ${id}`);
                
                const { error } = await supabaseAdmin
                    .from('questions')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                alert('âœ… QuestÃ£o deletada do Supabase!');
                loadQuestions();
                
            } catch (error) {
                console.error('âŒ Erro ao deletar:', error);
                alert(`âŒ Erro ao deletar: ${error.message}`);
            }
        }

        
    </script>
</body>
</html>

