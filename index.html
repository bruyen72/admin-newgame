<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUIRON MASTER ADMIN</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #0f172a; color: white; min-height: 100vh; }
        .header { background: #1e293b; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; position: sticky; top: 0; z-index: 1000; }
        .header h1 { font-size: 18px; color: #60a5fa; font-weight: 800; }
        .btn { padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; border: none; transition: 0.2s; display: inline-flex; align-items: center; gap: 6px; }
        .btn-secondary { background: rgba(255,255,255,0.05); color: #cbd5e1; border: 1px solid rgba(255,255,255,0.1); }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        .toolbar { background: #1e293b; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; border: 1px solid #334155; }
        .search-box { flex: 1; }
        .search-box input { width: 100%; padding: 10px; border-radius: 8px; background: #0f172a; border: 1px solid #334155; color: white; font-size: 13px; }
        .layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
        .sidebar { background: #1e293b; border-radius: 12px; padding: 15px; height: fit-content; position: sticky; top: 75px; border: 1px solid #334155; }
        
        .area-card { 
            padding: 12px; border-radius: 8px; cursor: pointer; color: #94a3b8; font-size: 13px; margin-bottom: 5px; 
            border: 2px solid transparent; transition: 0.2s; display: flex; justify-content: space-between; align-items: center;
        }
        .area-card:hover { background: rgba(255,255,255,0.05); }
        .area-card.active { background: #3b82f622; color: #60a5fa; font-weight: 700; border-color: #3b82f644; }
        
        .count-badge { 
            display: inline-flex; gap: 4px; align-items: center;
        }
        .pill {
            padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 900; 
            background: rgba(255,255,255,0.05); color: #64748b; border: 1px solid rgba(255,255,255,0.05);
        }
        .pill-total { color: #60a5fa; background: #3b82f611; border-color: #3b82f622; }
        .pill-ce { color: #10b981; background: #10b98111; border-color: #10b98122; }
        .pill-multi { color: #f59e0b; background: #f59e0b11; border-color: #f59e0b22; }
        
        .active .pill-total { background: #3b82f633; border-color: #3b82f644; }

        .materias-list { margin-top: 5px; padding-left: 10px; display: none; border-left: 2px solid #334155; margin-bottom: 10px; }
        .materias-list.show { display: block; }
        .materia-item { padding: 6px 10px; font-size: 11px; color: #64748b; cursor: pointer; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .materia-item:hover { color: #e2e8f0; background: rgba(255,255,255,0.03); }
        .materia-item.active { color: #10b981; font-weight: 800; background: #10b98111; }

        .questions-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 15px; }
        .question-card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 20px; position: relative; }
        .q-tag { font-size: 9px; font-weight: 800; color: #60a5fa; background: #3b82f611; padding: 2px 6px; border-radius: 4px; margin-right: 5px; text-transform: uppercase; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: #1e293b; border-radius: 20px; width: 100%; max-width: 700px; border: 1px solid #334155; overflow: hidden; }
        .modal-body { padding: 30px; overflow-y: auto; max-height: 75vh; }
        .modal-footer { padding: 20px 30px; background: #252f3f; display: flex; gap: 10px; }
        .alt-row { display: flex; gap: 10px; align-items: center; background: #162031; padding: 10px; border-radius: 8px; margin-bottom: 5px; border: 1px solid transparent; }
        .alt-row.correct-selected { border-color: #10b981; background: #10b98108; }
        input, select, textarea { width: 100%; padding: 10px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: white; font-size: 14px; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>QUIRON MASTER ADMIN</h1>
        <div style="display:flex; gap:10px; align-items:center;">
            <div id="status" style="font-size:10px; color:#10b981; font-weight:bold;">‚óè CONECTADO</div>
            <button class="btn btn-secondary" onclick="location.href='dashboard.html'">VOLTAR</button>
        </div>
    </div>
    <div class="container">
        <div class="toolbar">
            <div class="search-box"><input type="text" id="search" placeholder="Pesquisar termo..." onkeyup="render()"></div>
            <div style="display:flex; gap:10px;">
                <select id="filterType" onchange="render()" class="btn btn-secondary" style="background:#0f172a; border:1px solid #334155; height:35px; width:auto; margin:0;">
                    <option value="all">üìö Ver Todas</option>
                    <option value="game">üéÆ Apenas Jogo (C/E)</option>
                    <option value="multi">üìù Apenas M√∫ltipla (A,B,C,D)</option>
                </select>
                <button class="btn btn-secondary" onclick="resetSystem()" style="color:#ef4444;">üßπ LIMPAR</button>
                <button class="btn btn-primary" onclick="playInArena()" style="background:#3b82f6;">üéÆ JOGAR</button>
                <button class="btn btn-success" onclick="openAddModal()">+ NOVA</button>
            </div>
        </div>
        <div class="layout">
            <div class="sidebar">
                <h3 style="font-size:10px; color:#475569; margin-bottom:10px; text-transform:uppercase;">Filtrar</h3>
                <div id="areaList"></div>
            </div>
            <div id="questionsList" class="questions-grid">
                <div id="globalSummary" style="grid-column: 1/-1; background: #1e293b; padding: 15px; border-radius: 12px; border: 1px solid #334155; margin-bottom: 10px; display: flex; gap: 20px; align-items: center; justify-content: center;">
                    <div style="color: #94a3b8; font-size: 12px; font-weight: 600;">RESUMO DO BANCO:</div>
                    <div class="pill pill-total" id="stat-total" style="font-size: 12px; padding: 4px 12px;">Total: 0</div>
                    <div class="pill pill-ce" id="stat-ce" style="font-size: 12px; padding: 4px 12px;">Certo/Errado: 0</div>
                    <div class="pill pill-multi" id="stat-multi" style="font-size: 12px; padding: 4px 12px;">M√∫ltipla: 0</div>
                </div>
                <div style="grid-column: 1/-1; text-align:center; padding:100px; opacity:0.3;">Conectando...</div>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div class="modal" id="modal">
        <div class="modal-content" style="max-width: 800px; background: #1e293b; border: 1px solid #334155; box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
            <div style="padding: 20px 30px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; background: #162031;">
                <h2 id="modalTitle" style="font-size: 16px; font-weight: 800; color: #60a5fa; letter-spacing: 1px;">üìù GEST√ÉO DE QUEST√ÉO</h2>
                <button type="button" onclick="closeModal()" style="background:none; border:none; color:#64748b; cursor:pointer; font-size:20px;">&times;</button>
            </div>
            <form id="form">
                <div class="modal-body" style="padding: 30px;">
                    <input type="hidden" id="id">
                    
                    <!-- SE√á√ÉO 1: CLASSIFICA√á√ÉO -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="font-size: 11px; color: #475569; text-transform: uppercase; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                            <span style="background: #3b82f6; width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; color: white; font-size: 9px;">1</span>
                            ONDE ESTA QUEST√ÉO SER√Å EXIBIDA? (PASTAS)
                        </h3>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; background: rgba(0,0,0,0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.03);">
                            <div>
                                <label style="font-size:11px; color:#94a3b8; font-weight: 700; margin-bottom: 8px; display: block;">√ÅREA (PASTA M√ÉE)</label>
                                <div style="display:flex; gap: 8px;">
                                    <select id="qArea" required onchange="updateModalSubjects()" style="flex:1; margin:0;"></select>
                                    <button type="button" onclick="addAreaUI()" class="btn btn-secondary" style="padding: 0 12px; height: 40px; background: #3b82f622; border-color: #3b82f644; color: #60a5fa;" title="Nova √Årea">+</button>
                                </div>
                            </div>
                            <div>
                                <label style="font-size:11px; color:#94a3b8; font-weight: 700; margin-bottom: 8px; display: block;">MAT√âRIA (SUB-PASTA)</label>
                                <div style="display:flex; gap: 8px;">
                                    <select id="qSubject" required style="flex:1; margin:0;"></select>
                                    <button type="button" onclick="addSubjectUI()" class="btn btn-secondary" style="padding: 0 12px; height: 40px; background: #10b98122; border-color: #10b98144; color: #10b981;" title="Nova Mat√©ria">+</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SE√á√ÉO 2: CONTE√öDO -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="font-size: 11px; color: #475569; text-transform: uppercase; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                            <span style="background: #3b82f6; width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; color: white; font-size: 9px;">2</span>
                            TIPO E TEXTO DA QUEST√ÉO
                        </h3>
                        <div style="background: rgba(0,0,0,0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.03);">
                            <div style="margin-bottom: 15px;">
                                <label style="font-size:11px; color:#94a3b8; font-weight: 700; margin-bottom: 8px; display: block;">FORMATO DA RESPOSTA</label>
                                <select id="qType" onchange="toggleType()" style="background: #0f172a; border-color: #334155; font-weight: 700;">
                                    <option value="certo_errado">‚úÖ CERTO OU ERRADO (Padr√£o Jogo)</option>
                                    <option value="multipla">üìù M√öLTIPLA ESCOLHA (A, B, C, D)</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:11px; color:#94a3b8; font-weight: 700; margin-bottom: 8px; display: block;">ENUNCIADO (PERGUNTA)</label>
                                <textarea id="text" rows="4" required style="background: #0f172a; border-color: #334155; line-height: 1.6;" placeholder="Digite aqui o texto da quest√£o..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- SE√á√ÉO 3: RESPOSTA -->
                    <div>
                        <h3 style="font-size: 11px; color: #475569; text-transform: uppercase; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                            <span style="background: #3b82f6; width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; color: white; font-size: 9px;">3</span>
                            GABARITO E EXPLICA√á√ÉO
                        </h3>
                        <div style="background: rgba(0,0,0,0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.03);">
                            <div id="editorCE">
                                <label style="font-size:11px; color:#94a3b8; font-weight: 700; margin-bottom: 8px; display: block;">RESPOSTA CORRETA</label>
                                <select id="correctCE" style="background: #0f172a; border-color: #10b98144; color: #10b981; font-weight: 800;">
                                    <option value="C">CERTO</option>
                                    <option value="E">ERRADO</option>
                                </select>
                            </div>
                            <div id="editorMultipla" style="display:none;">
                                <label style="font-size:11px; color:#94a3b8; font-weight: 700; margin-bottom: 8px; display: block;">DEFINA AS ALTERNATIVAS E MARQUE A CORRETA</label>
                                <div id="altsEditor"></div>
                            </div>
                            <div style="margin-top:20px;">
                                <label style="font-size:11px; color:#94a3b8; font-weight: 700; margin-bottom: 8px; display: block;">üí° POR QUE ESTA √â A RESPOSTA? (EXPLICA√á√ÉO)</label>
                                <textarea id="expl" rows="2" style="background: #0f172a; border-color: #334155;" placeholder="Explique para o aluno o motivo do gabarito..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 25px 30px; background: #162031; border-top: 1px solid #334155; gap: 15px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()" style="flex:1; height: 45px; font-weight: 800;">CANCELAR</button>
                    <button type="submit" id="saveBtn" class="btn btn-success" style="flex:2; height: 45px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);">üíæ SALVAR NO BANCO DE DADOS</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://lrmabyfaunhrdvdzocrz.supabase.co';
        const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxybWFieWZhdW5ocmR2ZHpvY3J6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MzM0NDg0NSwiZXhwIjoyMDc4OTIwODQ1fQ.itx7jK0e5J6AwR7Q_uRx4rsQfZzTay9qzL5VTOMOh4I'.trim();

        const quironClient = window.supabase.createClient(SUPABASE_URL, KEY, { auth: { persistSession: false } });

        let allQuestions = [], areas = [], currentArea = null, currentSubject = null;

        const MATERIAS_FIXAS = {
            '√Årea Jur√≠dica': ['Direito Penal', 'Direito Civil', 'Direito Constitucional', 'Direito Administrativo'],
            '√Årea Policial': ['Criminologia', 'Legisla√ß√£o Penal Especial', 'Direitos Humanos', 'Procedimentos Policiais', 'Medicina Legal'],
            'Fiscal-Banc√°ria': ['AFO', 'Contabilidade', 'Economia', 'Conhecimentos Banc√°rios'],
            'Conhecimentos Gerais': ['Portugu√™s', 'Racioc√≠nio L√≥gico', 'Inform√°tica', 'Atualidades']
        };

        function toggleType() {
            const type = document.getElementById('qType').value;
            document.getElementById('editorMultipla').style.display = type === 'multipla' ? 'block' : 'none';
            document.getElementById('editorCE').style.display = type === 'certo_errado' ? 'block' : 'none';
        }

        function norm(t) { 
            return t ? t.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, '') : ''; 
        }

        async function init() {
            try {
                const { data: config } = await quironClient.from('questions').select('options').eq('id', '00000000-0000-0000-0000-000000000000').maybeSingle();
                areas = config?.options?.areas || Object.keys(MATERIAS_FIXAS).map(name => ({ name, subjects: MATERIAS_FIXAS[name] }));
                renderAltsEditor();
                await load();
            } catch (e) { document.getElementById('questionsList').innerHTML = `<div style="grid-column:1/-1;text-align:center;color:#ef4444;">Erro ao conectar.</div>`; }
        }

        function renderAltsEditor() {
            document.getElementById('altsEditor').innerHTML = ['A','B','C','D'].map(l => `
                <div class="alt-row" id="row-${l}">
                    <input type="radio" name="correct" value="${l}" onchange="document.querySelectorAll('.alt-row').forEach(r=>r.classList.remove('correct-selected')); document.getElementById('row-${l}').classList.add('correct-selected')">
                    <span style="font-weight:900; width:20px; color:#475569;">${l}</span>
                    <input type="text" id="alt${l}" placeholder="Op√ß√£o ${l}" style="margin:0;">
                </div>`).join('');
        }

        async function load() {
            try {
                let allData = [];
                let page = 0;
                const pageSize = 1000;
                let hasMore = true;

                // Carregar at√© 5000 quest√µes (5 p√°ginas de 1000)
                while (hasMore && allData.length < 5000) {
                    const { data, error } = await quironClient
                        .from('questions')
                        .select('*')
                        .neq('id', '00000000-0000-0000-0000-000000000000')
                        .order('created_at', { ascending: false })
                        .range(page * pageSize, (page + 1) * pageSize - 1);

                    if (error) throw error;
                    if (!data || data.length === 0) {
                        hasMore = false;
                    } else {
                        allData = [...allData, ...data];
                        if (data.length < pageSize) hasMore = false;
                        page++;
                    }
                }

                if (allData.length > 0) {
                    allQuestions = allData.map(q => ({ ...q, assignedArea: detectArea(q) }));
                    
                    const stats = {};
                    allQuestions.forEach(q => {
                        const a = q.assignedArea;
                        if (!stats[a]) stats[a] = { total: 0, subjects: {} };
                        stats[a].total++;
                        const s = q.subject || 'Sem Mat√©ria';
                        stats[a].subjects[s] = (stats[a].subjects[s] || 0) + 1;
                    });
                    console.log('üìä RELAT√ìRIO FINAL:', stats);
                    
                    renderSidebar();
                    render();
                }
            } catch (e) { 
                console.error(e); 
                document.getElementById('questionsList').innerHTML = `<div style="grid-column:1/-1;text-align:center;color:#ef4444;">Erro ao carregar: ${e.message}</div>`;
            }
        }

        function detectArea(q) {
            const s = norm(q.subject || '');
            const tags = Array.isArray(q.tags) ? q.tags.map(t => norm(t)) : [norm(q.tags || '')];
            const text = norm(q.question_text || '');
            
            // 1. PRIORIDADE M√ÅXIMA: Match via nomes de √°reas configuradas (Dinamismo Total)
            for (let a of areas) { 
                const aNorm = norm(a.name);
                // Se a quest√£o tem a tag que bate com o nome da √°rea, ela PERTENCE a essa √°rea.
                if (tags.some(t => t === aNorm || (t.length > 3 && aNorm.includes(t)) || (aNorm.length > 3 && t.includes(aNorm)))) return a.name; 
            }

            // 2. REGRAS AUTOM√ÅTICAS (Fallback se n√£o houver tag espec√≠fica)
            // √ÅREA JUR√çDICA
            if (s.includes('civil') || s.includes('penal') || s.includes('constitucional') || s.includes('administrativo') || 
                s.includes('juridica') || s.includes('direito') || s.includes('processo') || s.includes('lei') || s.includes('tributario') ||
                s.includes('cidadania') || tags.some(t => t.includes('juridica') || t.includes('direito'))) {
                return '√Årea Jur√≠dica';
            }
            
            // √ÅREA POLICIAL
            if (s.includes('policial') || s.includes('criminologia') || s.includes('seguranca') || s.includes('investigacao') || 
                s.includes('desarmamento') || s.includes('medicina') || s.includes('etica') || s.includes('forca') ||
                tags.some(t => t.includes('policial'))) {
                return '√Årea Policial';
            }

            // FISCAL-BANC√ÅRIA
            if (s.includes('fiscal') || s.includes('bancaria') || s.includes('contabil') || s.includes('economia') || s.includes('afo') ||
                s.includes('financeira') || s.includes('mercado') || s.includes('orcamento') ||
                tags.some(t => t.includes('fiscal') || t.includes('bancaria'))) {
                return 'Fiscal-Banc√°ria';
            }

            // CONHECIMENTOS GERAIS
            if (s.includes('portugues') || s.includes('informatica') || s.includes('raciocinio') || s.includes('logico') ||
                s.includes('atualidades') || s.includes('historia') || s.includes('geografia') || s.includes('ambiente') ||
                s.includes('cultura') || tags.some(t => t.includes('geral') || t.includes('conhecimento'))) {
                return 'Conhecimentos Gerais';
            }

            return 'Outros';
        }

        function renderSidebar() {
            const list = document.getElementById('areaList');
            
            const getBadgeHTML = (list) => {
                const ce = list.filter(q => q.correct_answer === 'C' || q.correct_answer === 'E').length;
                const multi = list.length - ce;
                return `
                    <div class="count-badge">
                        <span class="pill pill-total" title="Total">${list.length}</span>
                        <span class="pill pill-ce" title="Certo/Errado">üéÆ${ce}</span>
                        <span class="pill pill-multi" title="M√∫ltipla Escolha">üìù${multi}</span>
                    </div>`;
            };

            let html = `<div class="area-card ${!currentArea?'active':''}" onclick="selectArea(null)">
                <span>üìã Todas</span>
                ${getBadgeHTML(allQuestions)}
            </div>`;
            
            areas.forEach(a => {
                const isActive = currentArea === a.name;
                const subjects = a.subjects || MATERIAS_FIXAS[a.name] || [];
                const questionsInArea = allQuestions.filter(q => norm(q.assignedArea) === norm(a.name));
                
                html += `<div class="area-card ${isActive?'active':''}" onclick="selectArea('${a.name}')" style="position:relative; group">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span onclick="editAreaConfig('${a.name}', event)" style="cursor:pointer; opacity:0.5; font-size:10px;" title="Configurar Pasta">‚öôÔ∏è</span>
                        <span>${a.icon || 'üìÇ'} ${a.name}</span>
                    </div>
                    ${getBadgeHTML(questionsInArea)}
                </div>
                <div class="materias-list ${isActive?'show':''}">
                    ${subjects.map(s => {
                        const sNorm = norm(s); 
                        const subSet = questionsInArea.filter(q => {
                            const qSubNorm = norm(q.subject || '');
                            const qTags = (Array.isArray(q.tags) ? q.tags : [q.tags]).map(t => norm(t));
                            if (sNorm.includes('penal') && qSubNorm.includes('penal')) return true;
                            if (sNorm.includes('civil') && qSubNorm.includes('civil')) return true;
                            if (sNorm.includes('constitucional') && (qSubNorm.includes('constitucional') || qSubNorm.includes('cidadania') || qSubNorm.includes('humanos'))) return true;
                            if (sNorm.includes('administrativo') && qSubNorm.includes('administrativo')) return true;
                            if (sNorm.includes('portugues') && qSubNorm.includes('portugues')) return true;
                            if (sNorm.includes('logico') && qSubNorm.includes('raciocinio')) return true;
                            if (sNorm.includes('informatica') && qSubNorm.includes('informatica')) return true;
                            return qSubNorm.includes(sNorm) || sNorm.includes(qSubNorm) || qTags.includes(sNorm);
                        });
                        return `<div class="materia-item ${currentSubject==s?'active':''}" onclick="selectSubject('${s}', event)">
                            <span>${s}</span>
                            ${getBadgeHTML(subSet)}
                        </div>`;
                    }).join('')}
                </div>`;
            });
            
            const outrosSet = allQuestions.filter(q => q.assignedArea === 'Outros');
            list.innerHTML = html + `<div class="area-card ${currentArea=='Outros'?'active':''}" onclick="selectArea('Outros')">
                <span>‚ùì Outros</span>
                ${getBadgeHTML(outrosSet)}
            </div>`;
            document.getElementById('qArea').innerHTML = areas.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
        }

        function render() {
            const search = document.getElementById('search').value.toLowerCase();
            const typeFilter = document.getElementById('filterType').value;

            const filtered = allQuestions.filter(q => {
                if (currentArea && norm(q.assignedArea) !== norm(currentArea)) return false;
                
                if (currentSubject) {
                    const sNorm = norm(currentSubject);
                    const qSubNorm = norm(q.subject || '');
                    const qTags = (Array.isArray(q.tags) ? q.tags : [q.tags]).map(t => norm(t));
                    const match = qSubNorm.includes(sNorm) || sNorm.includes(qSubNorm) || qTags.includes(sNorm);
                    if (!match) return false;
                }

                const isCE = q.correct_answer === 'C' || q.correct_answer === 'E';
                if (typeFilter === 'game' && !isCE) return false;
                if (typeFilter === 'multi' && isCE) return false;

                if (search && !q.question_text.toLowerCase().includes(search)) return false;
                return true;
            });

            // Calcular n√∫meros para o resumo
            const ceCount = filtered.filter(q => q.correct_answer === 'C' || q.correct_answer === 'E').length;
            const multiCount = filtered.length - ceCount;

            // Renderizar tudo de uma vez
            document.getElementById('questionsList').innerHTML = `
                <div id="globalSummary" style="grid-column: 1/-1; background: #1e293b; padding: 15px; border-radius: 12px; border: 1px solid #334155; margin-bottom: 10px; display: flex; gap: 20px; align-items: center; justify-content: center;">
                    <div style="color: #94a3b8; font-size: 12px; font-weight: 600;">FILTRADOS:</div>
                    <div class="pill pill-total" style="font-size: 12px; padding: 4px 12px;">Total: ${filtered.length}</div>
                    <div class="pill pill-ce" style="font-size: 12px; padding: 4px 12px;">üéÆ Certo/Errado: ${ceCount}</div>
                    <div class="pill pill-multi" style="font-size: 12px; padding: 4px 12px;">üìù M√∫ltipla: ${multiCount}</div>
                </div>
            ` + filtered.map(q => `
                <div class="question-card">
                    <div style="margin-bottom:10px;"><span class="q-tag" style="background:#3b82f622; color:#60a5fa; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:800;">${q.assignedArea}</span></div>
                    <div style="font-size:14px; line-height:1.5;">${q.question_text}</div>
                    <div style="display:flex; gap:10px; margin-top:15px;"><button class="btn btn-secondary" onclick="edit('${q.id}')">EDITAR</button><button class="btn btn-secondary" style="color:#ef4444; border-color:#ef444433;" onclick="del('${q.id}')">EXCLUIR</button></div>
                </div>`).join('');
        }

        function selectArea(n) { currentArea = n; currentSubject = null; renderSidebar(); render(); }
        function selectSubject(s, e) { e.stopPropagation(); currentSubject = (currentSubject === s) ? null : s; renderSidebar(); render(); }

        async function addAreaUI() {
            const name = prompt("Nome da nova √Årea (Ex: VIP):");
            if(!name) return;
            const newArea = { id: Date.now(), name: name, subjects: ["Geral"], icon: "üìÇ", color: "bg-blue" };
            areas.push(newArea);
            await saveConfig();
            renderSidebar();
            document.getElementById('qArea').innerHTML = areas.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
            document.getElementById('qArea').value = name;
            updateModalSubjects();
        }

        async function editAreaConfig(name, event) {
            event.stopPropagation();
            const area = areas.find(a => a.name === name);
            if(!area) return;

            const newIcon = prompt("Digite um Emoji para o √≠cone (Ex: üèÜ, ‚öñÔ∏è, üö®):", area.icon || "üìÇ");
            const newColor = prompt("Escolha a cor (bg-blue, bg-red, bg-purple, bg-orange, bg-emerald, bg-indigo, bg-pink):", area.color || "bg-blue");
            
            if(newIcon) area.icon = newIcon;
            if(newColor) area.color = newColor;
            
            await saveConfig();
            alert("‚úÖ Configura√ß√£o da pasta atualizada!");
            renderSidebar();
        }

        async function addSubjectUI() {
            const areaName = document.getElementById('qArea').value;
            const area = areas.find(a => a.name === areaName);
            if(!area) return;
            const sub = prompt(`Nova Mat√©ria para ${areaName}:`);
            if(!sub) return;
            if(!area.subjects) area.subjects = [];
            if(!area.subjects.includes(sub)) area.subjects.push(sub);
            await saveConfig();
            renderSidebar();
            updateModalSubjects();
            document.getElementById('qSubject').value = sub;
        }

        async function saveConfig() {
            const { error } = await quironClient.from('questions').update({ options: { areas: areas } }).eq('id', '00000000-0000-0000-0000-000000000000');
            if(error) alert("Erro ao salvar configura√ß√£o: " + error.message);
        }

        async function resetSystem() {
            if(!confirm("Isso vai resetar as √°reas customizadas para o padr√£o. Continuar?")) return;
            const defaultAreas = [
                { id: 1, name: '√Årea Jur√≠dica', desc: 'Constitucional, Adm...', icon: '‚öñÔ∏è', color: 'bg-blue' },
                { id: 'policial', name: '√Årea Policial', desc: 'Penal, Processo...', icon: 'üöî', color: 'bg-red' },
                { id: 3, name: 'Conhecimentos Gerais', desc: 'Portugu√™s, RLM...', icon: 'üß†', color: 'bg-purple' },
                { id: 4, name: 'Fiscal-Banc√°ria', desc: 'Econ, Contabilidade...', icon: 'üìä', color: 'bg-orange' }
            ];
            const { error } = await quironClient.from('questions').update({ options: { areas: defaultAreas } }).eq('id', '00000000-0000-0000-0000-000000000000');
            if(error) alert("Erro: " + error.message);
            else { alert("‚úÖ Sistema limpo! Reiniciando..."); location.reload(); }
        }

        function playInArena() {
            if (!currentArea) {
                alert("Selecione uma √ÅREA no menu lateral primeiro!");
                return;
            }

            // Mapeamento de nomes para slugs do sistema
            const areaMap = {
                '√Årea Jur√≠dica': 'juridica',
                '√Årea Policial': 'policial',
                'Fiscal-Banc√°ria': 'fiscal-bancaria',
                'Conhecimentos Gerais': 'conhecimentos-gerais'
            };

            let areaSlug = areaMap[currentArea] || norm(currentArea);
            const subjectSlug = currentSubject ? norm(currentSubject) : '';
            // Caminho relativo para funcionar no Vercel/Produ√ß√£o
            const gamePath = '/godot-game/index.html';
            
            let url = `${gamePath}?area=${areaSlug}`;
            if (subjectSlug) url += `&subjects=${subjectSlug}`;

            console.log("üöÄ Iniciando Arena:", { area: areaSlug });
            window.open(url, '_blank');
        }

        function openAddModal() { document.getElementById('form').reset(); document.getElementById('id').value = ""; document.getElementById('qType').value="certo_errado"; toggleType(); updateModalSubjects(); document.getElementById('modal').classList.add('show'); }
        function closeModal() { document.getElementById('modal').classList.remove('show'); }
        function updateModalSubjects() { const a = areas.find(x => x.name === document.getElementById('qArea').value); document.getElementById('qSubject').innerHTML = (a?.subjects || MATERIAS_FIXAS[a?.name] || ['Geral']).map(s => `<option value="${s}">${s}</option>`).join(''); }

        async function edit(id) {
            const q = allQuestions.find(x => x.id === id);
            if(!q) return;
            document.getElementById('id').value = q.id;
            document.getElementById('qArea').value = q.assignedArea;
            updateModalSubjects();
            document.getElementById('qSubject').value = q.subject;
            document.getElementById('text').value = q.question_text;
            document.getElementById('expl').value = q.explanation || "";
            const opts = q.options?.alternatives || {};
            ['A','B','C','D'].forEach(l => document.getElementById('alt'+l).value = opts[l] || "");
            const radio = document.querySelector(`input[name="correct"][value="${q.correct_answer}"]`);
            if(radio) { radio.checked = true; document.querySelectorAll('.alt-row').forEach(r=>r.classList.remove('correct-selected')); document.getElementById('row-'+q.correct_answer).classList.add('correct-selected'); }
            document.getElementById('modal').classList.add('show');
        }

        document.getElementById('form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('saveBtn');
            btn.disabled = true; btn.textContent = "SALVANDO...";
            const type = document.getElementById('qType').value;
            const payload = {
                id: document.getElementById('id').value || crypto.randomUUID(),
                question_text: document.getElementById('text').value, subject: document.getElementById('qSubject').value,
                difficulty: 'M√âDIO', explanation: document.getElementById('expl').value || "Sistema", theme: 'NORMAL', tags: [document.getElementById('qArea').value],
                correct_answer: type === 'certo_errado' ? document.getElementById('correctCE').value : document.querySelector('input[name="correct"]:checked').value,
                options: { alternatives: type === 'certo_errado' ? { C: "Certo", E: "Errado" } : { A: document.getElementById('altA').value, B: document.getElementById('altB').value, C: document.getElementById('altC').value, D: document.getElementById('altD').value } }
            };
            const { error } = await quironClient.from('questions').upsert(payload);
            if(error) alert("Erro ao salvar: " + error.message); else { alert("‚úÖ Salvo!"); closeModal(); await load(); }
            btn.disabled = false; btn.textContent = "SALVAR NO BANCO";
        };

        async function del(id) {
            if(confirm("Excluir permanentemente?")) {
                const { error } = await quironClient.from('questions').delete().eq('id', id);
                if(error) alert("Erro ao excluir: " + error.message); else { alert("üóëÔ∏è Exclu√≠do!"); await load(); }
            }
        }
        init();
    </script>
</body>
</html>
